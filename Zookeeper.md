## Zookeeper介绍

Zookeeper是分布式数据管理与协调框架。分布式应用可以基于Zookeeper实现数据发布订阅、命名服务、Master选举、分布式锁、集群管理等功能。

## ZAB协议

ZAB协议是为Zookeeper专门设计的一种支持崩溃恢复的原子广播协议。在Zookeeper中，主要依赖ZAB协议来实现分布式数据的一致性。

首先，在Zookeeper中使用单一的Master进程来接收并处理客户端的所有事务请求，然后通过ZAB协议将

ZAB协议包括两种基本模式：崩溃恢复、消息广播。

### 崩溃恢复

在Zookeeper启动时，或者当Leader服务器崩溃时，ZAB协议就会进入崩溃恢复模式。在该模式中，会进行新Leader的选举和数据状态的同步。当选举产生了新的Leader并且集群中过半的集器与该Leader状态同步成功之后，ZAB协议就会退出崩溃恢复模式。

#### Leader选举过程

选举流程简述
目前有5台服务器，每台服务器均没有数据，它们的编号分别是1,2,3,4,5,按编号依次启动，它们的选择举过程如下：

服务器1启动，给自己投票，然后发投票信息，由于其它机器还没有启动所以它收不到反馈信息，服务器1的状态一直属于Looking。
服务器2启动，给自己投票，同时与之前启动的服务器1交换结果，由于服务器2的编号大所以服务器2胜出，但此时投票数没有大于半数，所以两个服务器的状态依然是LOOKING。
服务器3启动，给自己投票，同时与之前启动的服务器1,2交换信息，由于服务器3的编号最大所以服务器3胜出，此时投票数正好大于半数，所以服务器3成为领导者，服务器1,2成为小弟。
服务器4启动，给自己投票，同时与之前启动的服务器1,2,3交换信息，尽管服务器4的编号大，但之前服务器3已经胜出，所以服务器4只能成为小弟。
服务器5启动，后面的逻辑同服务器4成为小弟。

### 消息广播

## Zookeeper中的节点

### 节点类型

- 持久节点：该节点被创建后，就会一直存在于Zookeeper服务器上，直到主动删除这个节点。
- 持久顺序节点：除了持久性外，还保证节点间的顺序性。即每个父节点都会为它的第一级子节点维护子节点创建的先后顺序。在顺序节点的创建时，会自动为该节点名后添加一个数字后缀
- 临时节点：节点的生命周期与客户端绑定，当客户端的会话失效，节点就自动被清理。临时节点只能作为叶子节点。
- 临时顺序节点：即临时节点+顺序节点。



在Zookeeper中，事务是指能够改变Zookeeper服务器状态的操作。一般包括数据节点创建、删除、节点内容更新、客户端会话创建与失效等。

对于每个一事务请求，Zookeeper都会为其分配一个全局唯一的事务Id，用ZXID表示，从ZXID中就可以看出Zookeeper处理事务的全局顺序。



## Zookeeper的典型应用场景

### 分布式锁

#### 排他锁

排他锁的核心是如何保证当前有且只有一个事务获得锁，并且锁被释放后，所有正在等待获取锁的事务都能被通知到。

- 排他锁的获取：多个客户端都会调用create()方法，试图在某个节点如/EXCLUSIVE_LOCK下创建一个名为LOCK的临时子节点。但Zookeeper会保证在所有的客户端中，最终只能有一个成功创建节点。则该客户端就获得了锁。这样其他没有获取到锁的客户端需要在EXCLUSIVE_LOCK节点上注册子节点变更的Watcher监听，就可以获得锁的变更情况。
- 排他锁的释放：由于/EXCLUSIVE_LOCK下的LOCK节点是一个临时节点，这样当获取锁的客户端发生异常时，或者当客户端逻辑执行完成并主动删除该节点，
- 锁的可重入：

#### 共享锁

- 共享锁的获取：多个客户端都会调用create()方法，试图在某个节点如/SHARED_LOCK下创建临时顺序节点。之后进行读写顺序的确定，如果当前客户端无法获取共享锁，则在SHARED_LOCK注册子节点变更的Watcher监听。
- 读写顺序的确定
  - 对于读请求，如果没有比自己序号小的子节点，或者所有比自己序号小的节点都是读请求，则表明该读请求获取共享锁成功。
  - 对于写请求，如果自己是序号最小的子节点，则表明该写请求获取共享锁成功。
- 共享锁的释放：同排他锁。
- 共享锁的羊群效应：即在共享锁的获取与释放过程中，当某个客户端释放了共享锁，Zookeeper就会在短时间内向其他客户端发送大量的通知事件，会对zookeeper服务器造成巨大的性能影响。为了防止羊群效应，对每个想要获得共享锁的客户端，只需要关心/SHARED_LOCK节点下比自己小的那个节点是否存在即可。

### 数据发布订阅

数据发布订阅系统，即所谓的配置中心，就是发布者将数据发布到Zookeeper的节点，订阅者订阅该节点中的数据，这样来完成数据的动态发布订阅。

Zookeeper采用推拉结合的方式，来完成数据的发布订阅过程。即客户端对需要关注的节点注册Watcher事件监听，如果该节点的数据发生变更，服务器就会向该客户端发送Watcher事件的通知。当客户端收到该事件通知后，就会主动到服务器获取最新的数据信息。

### 命名服务

即通过顺序节点的特点，生成全局唯一ID

