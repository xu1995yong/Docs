# Redis

Redis 是一个高性能的key-value数据库。

Redis 有以下三个特点：

- Redis支持数据的持久化，可以将内存中的数据保存在磁盘中。
- Redis有丰富的数据类型。
- Redis支持master-slave模式的数据备份。

## Redis 基础数据结构

Redis支持五种数据类型：string（字符串），hash（哈希），list（列表），set（集合）及zset(有序集合)。Redis 所有的数据结构都是以唯一的 key 字符串作为名称，然后通过这个唯一 key 值来获取相应的 value值。所以Redis的数据类型均是指value值的类型。

- String类型：表示的是可变的字节数组。Redis 的String是动态字符串，是可以修改的字符串。String结构使用非常广泛，一个常见的用途就是 JSON 序列化的形式缓存用户信息。
- LIST类型：表示的是双向链表。这意味着 list 的插入和删除操作非常快，时间复杂度为 O(1)，但是索引定位很慢，时间复杂度为 O(n)。Redis 的List常用来做异步队列使用。将需要延后处理的任务序列化成字符串塞进 Redis 的列表，另一个线程从这个列表中轮询数据进行处理。
- SET类型：表示的是无序集合。它内部的键值对是无序且唯一的。它的内部实现相当于一个特殊的Hash类型，即所有的value都是NULL值。
- ZSET类型：表示的是有序集合。它给value都赋予一个 score，代表这个value的排序权重。它的内部是通过一种叫做**跳跃列表**的数据结构来实现的。
  zset 可以用来存粉丝列表，value 值是粉丝的用户 ID，score 是关注时间。我们可以对粉丝列表按关注时间进行排序。zset 还可以用来存储学生的成绩，value 值是学生的 ID，score 是他的考试成绩。我们可以对成绩按分数进行排序就可以得到他的名次。
- Hash类型：表示的是包含键值对的无序散列表。基于数组加链表的二维结构实现。Redis中Hash类型的值只能是字符串。

### 键的过期时间

Redis 可以为每个键设置过期时间，当键过期时，会自动删除该键。对于散列表这种容器，只能为整个键设置过期时间（整个散列表），而不能为键里面的单个元素设置过期时间。

## Redis的应用

### 乐观锁

```bash
WATCH key # 监视key的状态，只有当被监视的Key没有被修改，事务才会执行。
MULTI # 标记一个事务块的开始。 随后的指令将在执行EXEC时作为一个原子执行

do-something... # 所有的命令都会进入事务队列，等待执行。

EXEC # 执行事务中所有在排队等待的指令并将链接状态恢复到正常 
```

### 分布式锁

分布式锁用于分布式系统中并发问题的处理。

```bash
#创建一个锁并设置过期时间，该命令是原子操作。设置过期时间保证了当执行异常出错时锁也会释放。
SET key value [EX seconds] [PX milliseconds] [NX|XX] 
# PX milliseconds：设置键key的过期时间，单位时毫秒
# NX ：只有键key不存在的时候才会设置key的值

> set lock true ex 5 nx 
OK
... do something critical ...
> del lock
```

 超时问题：Redis 的分布式锁不能解决超时问题，如果在加锁和释放锁之间的逻辑执行的太长，以至于超出了锁的超时限制，这时候前一个线程的逻辑还没有执行完，第二个线程就提前持有了这把锁，导致临界区代码不能得到严格的串行执行。为了避免这个问题，Redis 分布式锁不要用于较长时间的任务。如果真的偶尔出现了，数据出现的小波错乱可能需要人工介入解决

分布式锁的可重入性：Redis 分布式锁如果要支持可重入，需要使用线程的 Threadlocal 变量存储当前持有锁的计数。

### 延时队列

Redis 的 list(列表) 数据结构常用来作为异步消息队列使用，使用`rpush/lpush`操作入队列，使用`lpop 和 rpop`来出队列。

### 位图

位图就是将byte数组当成**位数组**操作。我们可以使用普通的 get/set 直接获取和设置整个位图的内容，也可以使用位图操作 getbit/setbit 等将 byte 数组看成「位数组」来处理。

### 布隆过滤器

Redis 官方提供的布隆过滤器到了 Redis 4.0 提供了插件功能之后才正式登场。布隆过滤器作为一个插件加载到 Redis Server 中，给 Redis 提供了强大的布隆去重功能。

```bash
bf.add：添加元素
bf.exists：查询元素是否存在，
```

### 发布订阅

```bash

```





## Redis的原理

